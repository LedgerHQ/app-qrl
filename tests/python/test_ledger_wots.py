from __future__ import print_function

import binascii
import time

from ledgerblue.comm import getDongle
from ledgerblue.commException import CommException

try:
    dongle = getDongle(True)
except CommException as e:
    print(e)
    quit()

INS_VERSION = 0
INS_TEST_WOTS_PK_GEN = 100
INS_TEST_WOTS_SIGN = 101


def ledger_send(cmd, params=None):
    if params is None:
        params = []
    answer = None

    start = time.time()
    try:
        cmd_str = "80{0:02x}".format(cmd)
        for p in params:
            cmd_str = cmd_str + "{0:02x}".format(p)

        answer = dongle.exchange(binascii.unhexlify(cmd_str))
    except CommException as e:
        print("COMMEXC: ", e)
    except Exception as e:
        print("COMMEXC: ", e)
    end = time.time()
    print(end - start)
    return answer


def test_version():
    answer = ledger_send(INS_VERSION)
    assert len(answer) == 4
    assert answer[0] == 0xFF
    assert answer[1] == 0
    assert answer[2] == 0
    assert answer[3] == 1


def test_wots_pk_gen():
    answer = ledger_send(INS_TEST_WOTS_PK_GEN)
    assert len(answer) == 32
    signature = binascii.hexlify(answer[:32]).upper()
    assert signature == expected_wots_pk[0]

expected_wots_pk = [
    "3272DC7F025C6B49C02FCE5F80F796492A1D0147173A45BFC9B525A867CD77E4",
    "B530F130E68319329FC5D80FDF5550616B2126159FA37040110F03BFCCB56B5B",
    "A25DAC3B0CC5B7F13CA3F254CC23D4F9D2A28E2CEB3F573FA385134665909C13",
    "9BB2995F9F77A4C01813FE5FE8939D6E98F75763EB5C3D873C2B6E0BCA72A837",
    "4FAE27ABF000C31CB19DEBE7F5AE339658AD5F73D9D94A6415326C49C6F8FDC1",
    "864EE75A4D0192E7B658B0DDC538098FFB9A2C3B1890C1694D37481EB2C479FA",
    "133E32614CFBF87569B036E95BB9C26FCBCFF56DA29FE749E41E274B219F12F0",
    "92D2C297A8F9711D266286FC8A3C4E26EE0AD90B69673B533E9F18C25D093D4C",
    "D34C53F387999814CEBE4789D7AA27CD2F0760623CACF42FC4A03C8D1A1F4382",
    "ACD064C9FA9AD58FD84057C8D0411904191F416C7288D11B818CB231D2E92E19",
    "58D56A1746C897AC2736532C3EC3C7B7BA80A08ADE34E1ACEF4AB5D374A56287",
    "F8B2D3D315EB210F4E4E562B44DC633572012537500EE221D0997B812ADED62F",
    "17EC9A9729162CAFFFDB59F4461CAFD73D1FDE8EED72B362B057020E4BD9A660",
    "A1A212FBED48EEE963EDD7784D19DA2A7FFA2EC7D341B8A78767B11ECCC115A4",
    "0E8ACD4233EE04879F89289A76A144FA1448E3A6D511783B2F652EFA4644E597",
    "6667279FC8914A1A6F2BA5EC1A3D9573025AAC0C837CAF6B825252BC3AB81885",
    "C6ED7CB37B9DD11741C997F97DBF2F3064E301E489710355DC821A8C7F50EF76",
    "7896D902E8674480B71DABF3334E7AC2A8CC6FB2B4906EA14C1882240B94A865",
    "40E10C106047C90EE24B5533C328900699D251285F52BF43127E4FD740EABA3E",
    "8B6DCCCEFAB78E6F40CC182FED8335D2AFE4739D042808E340EFF879EE2FF301",
    "E545A0F746F5DC7F63B1349A2D5BF2F1BCF34CE9B9E20C91F2B45A8E8214C1D5",
    "5E29304D917E8B69237BDEEBF30B85083633F54CE2BF44C25D59B7F6EE17326B",
    "AA045F16DFAB401E34337E7DCBBBBE4232B64DBBDFA40BE846F39C16697748C0",
    "2F06F314034FCBE6AAD8B5FE90D1E8685AF9270549B82EDC9C51DC57E61A7304",
    "CEC29CDF24B8EF86C0AC10219E0D25849FBAEB9228207FCC5ADDFFC52DA38876",
    "EFF8F6C7EB9AC90FC7B6AE982A85B43300CFD298CB6F318CD98EFBC11F80FAB0",
    "D85C0979E9E4314DA08CC9749807E7B807CB22A8C53A21AE69BF7D57EC0B1AEB",
    "F203D9C426B8F7351561573226C4EBB0BE58D8753CA644173ADD441799787E86",
    "07F4A54CE75E5C59193E9E3F3596EE609A3DFFE28DA5384A04784C3CE12DE3CD",
    "ED0D7839CA4C0935C8EDB8A14E67EC4F8D6EBB9B6A452A22926B0735C8198A53",
    "A5569862E5BD14676102B137513CD644D41C68E828AA7B1E6F632B2809CCBD54",
    "5DEAF5D6073BF088A09A4244C8349DB799D1C0FCE9F2AD0E9659FC25B5601DB9",
    "90A16402AD093D72B988D36458C4F30648AD1281B928628886653BE2C3CE455E",
    "8581CF5E77BE938AAFA3F7CFC88C4113692AFE7961C4FF6715D806BAB3C6B8F7",
    "70A4876A4A319C33B3FDDD7C7C8579AE3E99EFC0948BDFB350927D80573FD8A9",
    "40A9A482F29720C49108D226641FFF489AC273998B53DF5877537B6E87A697B9",
    "25A012A63A62C16D8055B9054FCDF7AA944EB015A1D049DDFC7623B414FAB276",
    "EDE6531A207D13D5F69B8F854FD1711B3F0A43FA63741007B5CAB523A3E74A43",
    "4205344D33AACC4003223F02ADFB4D647BBABE22C5691FBE7E5B2098F1132817",
    "E0E774E1728F3A999424EC674ABDB668E8D526C30BEDA7D7225559820CEA20C1",
    "2B94A1183BF2C1DFE3895102FD3A1AFBB9CD6904A684358F6BC425085051CC8C",
    "A5D9ECE702C558B7F5F4151ECBEC680E1C1514132DA08998D534FB6454D38599",
    "AD17730C25275B9BD465557CE4AFEB949D28B0AF803AC2E7899A472E646011E7",
    "F58854584BF213B7617E3FCDA6F73F629022AA5118347D537CFEE3C6E031F9E0",
    "27D002803803D118003EF67B5C1CA09794154D5B10514724ABD832FA14B9599C",
    "159702374AE31BFD72DC457284CB3885D2C636E4D929AF81A40A3387F1C01F06",
    "13AFACD56C5A1085EE642FA802E267FF9162041A84932DDAD9A42C4A05283A08",
    "1E7D2AA478FA5C2C065DB2EF7FF335590D4001E0C691EC9C48D1C0F01EFF36AA",
    "0CCD334866449FBAF2B13534E5D41AB2F47201F129B7F9F7077E02D9892DF1A9",
    "60BF14AEDA0FA9809AB9313DE1CE4D268B43AC1C0A91FF216CCF04B3A8EB5F90",
    "EB09F99423FC15C674F1B9C67CAEDF50174C8FED32BA3587DBB0924C339F9DA7",
    "321FC37C660824E419BBD427D5EE4246895CD186C943B7B436C35DC2FC0355AF",
    "2BCEECD31D28E4F63002919A4C8C490C3E49A7A0B50F569B1F3CB3383234584E",
    "7C7878459F575CDB8ACAEDFB363C851FED94BA0793C4B69841D42BB7A765BDC4",
    "30A7331F51CE303BE8D414581CC96A56EC88CB9035673A6E55F051586D3C5E4F",
    "FD2B78F53B867F003E6C7711DE124C52D05FBB3E0A98AD2DEC78778CBCCCA70A",
    "25325AF69BBF43FA52FA77591D49C94B4B4415A5E4CA074B6932A048A3AD3EE8",
    "46AAF4E41CD238DF7D4EE3B5916414D1D8C8396B74C9F9E73C045BF9177E3F2F",
    "558157F168F275F371A34F88284F4A78F69DB2F20DB9585A4749E880F99C1618",
    "E71E68AE8D2880786529A5886FFA8F583D3FD0821A066336F06BAC8C7C170067",
    "CFF2516499313D42EF50B17BA0A5F7B7E339FC8FCBDC5B3B1A10D48A157C8FAA",
    "0BC5417E8996D5F98DA624E16915FE86076ACAB58FAA4FB546F54F827C32B0BD",
    "DD8E1D6BD75E8E81A77F9C82D2424FC1A1C967A81FC6135A34C5EC65F0968F44",
    "8FB06C99CB43EBE42FA67EA0D677FE28D6D77ED429C50D5FDD7E9A5EED784081",
    "9C7DBC09A64FC57EDDB5A1E7494C2A27B2C98C62582B9E3EB97E4D9C0445FDBA",
    "563925F7E7C1E2AE525CFD9EF8720DA0B776B530E5CF76B9187B9D699DEBAD08",
    "714B67C4FF90B7D2B6F8F44B7FD3E80931925C7C8E1F1BDDED3C48442D1C52D7",
]
